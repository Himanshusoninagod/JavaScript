(function (Drupal, once) {
  Drupal.behaviors.hasSubChildToggle = {
    attach(context) {
      once('initSubChildToggle', '.main-nav', context).forEach(() => {
        const vw = window.innerWidth;
        const subNavWraps = document.querySelectorAll('.sub-nav-wrap > ul');

        subNavWraps.forEach((subWrap) => {
          const allHasSubChildren = subWrap.querySelectorAll('.has-sub-child');

          if (vw > 991) {
            // Initial activation
            const firstHasSub = subWrap.querySelector('li:has(.has-sub-child) .has-sub-child');
            const firstInnerSub = firstHasSub?.querySelector('li:has(.has-inner-sub-child) .has-inner-sub-child');

            if (firstHasSub) firstHasSub.classList.add('active');
            if (firstInnerSub) firstInnerSub.classList.add('active-child');

            const topLevelLis = subWrap.querySelectorAll('li.top-level-li');

            topLevelLis.forEach((li) => {
              li.addEventListener('mouseenter', () => {
                const newSub = li.querySelector('.has-sub-child');

                  allHasSubChildren.forEach((el) => el.classList.remove('active'));
                  newSub.classList.add('active');
              });
            });

            subWrap.querySelectorAll('.has-sub-child').forEach((hasSub) => {
              const innerLis = hasSub.querySelectorAll('ul > li.first-level-li');
              const allInnerSubChildren = hasSub.querySelectorAll('.has-inner-sub-child');

              innerLis.forEach((li) => {
                li.addEventListener('mouseenter', () => {
                  const innerSub = li.querySelector('.has-inner-sub-child');
                    allInnerSubChildren.forEach((el) => el.classList.remove('active-child'));
                    innerSub.classList.add('active-child');
                });
              });
            });

          } else {
            subWrap.querySelectorAll('.has-sub-child').forEach((el) => el.classList.remove('active'));
            subWrap.querySelectorAll('.has-inner-sub-child').forEach((el) => el.classList.remove('active-child'));

            subWrap.querySelectorAll('ul > li > span').forEach((span) => {
              span.addEventListener('click', (event) => {
                event.stopPropagation();
                const parentLi = span.closest('li');
                const subChild = parentLi.querySelector('.has-sub-child');

                if (subChild) {
                  subWrap.querySelectorAll('.has-sub-child').forEach((el) => {
                    if (el !== subChild) el.classList.remove('active');
                  });
                  subChild.classList.toggle('active');
                }
              });
            });

            subWrap.querySelectorAll('.has-sub-child ul > li > span').forEach((span) => {
              span.addEventListener('click', (event) => {
                event.stopPropagation();
                const parentLi = span.closest('li');
                const innerSub = parentLi.querySelector('.has-inner-sub-child');

                if (innerSub) {
                  subWrap.querySelectorAll('.has-inner-sub-child').forEach((el) => {
                    if (el !== innerSub) el.classList.remove('active-child');
                  });
                  innerSub.classList.toggle('active-child');
                }
              });
            });
          }
        });
      });
    }
  };
})(Drupal, once);
